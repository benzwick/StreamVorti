# Run StreamVorti examples using pre-built binaries
#
# Downloads compiled binaries and runs them like a user would.

name: Run Examples

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["Build StreamVorti with ECL"]
    types: [completed]
    branches: [main]

jobs:
  run-cavity-sdl:
    name: "Cavity (SDL)"
    runs-on: ubuntu-22.04
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}

    steps:
    - uses: actions/checkout@v4

    - uses: actions/download-artifact@v4
      with:
        name: streamvorti-ecl-binaries-ubuntu-22.04
        path: bin
        run-id: ${{ github.event.workflow_run.id }}
        github-token: ${{ secrets.GITHUB_TOKEN }}

    - name: Install SBCL
      run: sudo apt-get update && sudo apt-get install -y sbcl

    - name: Run with SDL file
      run: |
        chmod +x bin/StreamVorti
        mkdir results && cd results
        ../bin/StreamVorti -f ../demo/cavity.lisp -pv 2>&1 | tee simulation.log

    - name: Validate against Ghia
      run: |
        sbcl --non-interactive \
             --load lisp/compare-ghia.lisp \
             --eval '(streamvorti.validation:run-validation :results-file "results/output_dat/mfem_square10x10_u_centerline_x0.5.dat")' \
             2>&1 | tee results/validation.log

    - uses: actions/upload-artifact@v4
      with:
        name: cavity-sdl-results
        path: results/

  run-cavity-cli:
    name: "Cavity (CLI)"
    runs-on: ubuntu-22.04
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}

    steps:
    - uses: actions/checkout@v4

    - uses: actions/download-artifact@v4
      with:
        name: streamvorti-ecl-binaries-ubuntu-22.04
        path: bin
        run-id: ${{ github.event.workflow_run.id }}
        github-token: ${{ secrets.GITHUB_TOKEN }}

    - name: Install SBCL
      run: sudo apt-get update && sudo apt-get install -y sbcl

    - name: Run with CLI args
      run: |
        chmod +x bin/StreamVorti
        mkdir results && cd results
        ../bin/StreamVorti -dim 2 -nx 20 -ny 20 -nn 25 -Re 100 -dt 0.005 -ft 5.0 -pv 2>&1 | tee simulation.log

    - name: Validate against Ghia
      run: |
        sbcl --non-interactive \
             --load lisp/compare-ghia.lisp \
             --eval '(streamvorti.validation:run-validation :results-file "results/output_dat/mfem_square10x10_u_centerline_x0.5.dat")' \
             2>&1 | tee results/validation.log

    - uses: actions/upload-artifact@v4
      with:
        name: cavity-cli-results
        path: results/

  run-mfemrun:
    name: "MfemRun"
    runs-on: ubuntu-22.04
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}

    steps:
    - uses: actions/checkout@v4

    - uses: actions/download-artifact@v4
      with:
        name: streamvorti-ecl-binaries-ubuntu-22.04
        path: bin
        run-id: ${{ github.event.workflow_run.id }}
        github-token: ${{ secrets.GITHUB_TOKEN }}

    - name: Run MfemRun
      run: |
        chmod +x bin/MfemRun
        mkdir results && cd results
        ../bin/MfemRun -dim 2 -nx 10 -ny 10 -nn 25 -sd -sn 2>&1 | tee mfemrun.log

    - uses: actions/upload-artifact@v4
      with:
        name: mfemrun-results
        path: results/
