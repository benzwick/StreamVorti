# Run StreamVorti examples using pre-built binaries
#
# Downloads compiled binaries and runs them like a user would.
# All results are saved as downloadable artifacts.

name: Run Examples

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["Build StreamVorti with ECL"]
    types: [completed]

jobs:
  run-cavity-sdl:
    name: "Cavity (SDL)"
    runs-on: ubuntu-22.04
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}

    steps:
    - uses: actions/checkout@v4

    - name: Download binaries (from triggering workflow)
      if: ${{ github.event_name == 'workflow_run' }}
      uses: actions/download-artifact@v4
      with:
        name: streamvorti-ecl-binaries-ubuntu-22.04
        path: bin
        run-id: ${{ github.event.workflow_run.id }}
        github-token: ${{ secrets.GITHUB_TOKEN }}

    - name: Download binaries (manual trigger - get latest)
      if: ${{ github.event_name == 'workflow_dispatch' }}
      uses: dawidd6/action-download-artifact@v3
      with:
        workflow: build-from-source-with-ecl.yml
        name: streamvorti-ecl-binaries-ubuntu-22.04
        path: bin

    - name: Install runtime dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y sbcl gnuplot libsuitesparse-dev libopenmpi-dev ecl

    - name: Run with SDL file
      run: |
        set -o pipefail
        chmod +x bin/StreamVorti
        mkdir -p results
        cd results
        ../bin/StreamVorti -f ../demo/cavity.lisp -lp ../lisp -pv 2>&1 | tee simulation.log

    - name: Validate against Ghia
      run: |
        set -o pipefail
        # SDL uses simulation name for output files
        sbcl --non-interactive \
             --load lisp/compare-ghia.lisp \
             --eval '(streamvorti.validation:run-validation :results-file "results/output_dat/lid-driven-cavity-2d_u_centerline_x0.5.dat")' \
             2>&1 | tee results/validation.log

    - name: Upload all results
      uses: actions/upload-artifact@v4
      with:
        name: cavity-sdl-results
        path: |
          results/
          demo/cavity.lisp
          data/
        retention-days: 90

  run-cavity-cli:
    name: "Cavity (CLI)"
    runs-on: ubuntu-22.04
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}

    steps:
    - uses: actions/checkout@v4

    - name: Download binaries (from triggering workflow)
      if: ${{ github.event_name == 'workflow_run' }}
      uses: actions/download-artifact@v4
      with:
        name: streamvorti-ecl-binaries-ubuntu-22.04
        path: bin
        run-id: ${{ github.event.workflow_run.id }}
        github-token: ${{ secrets.GITHUB_TOKEN }}

    - name: Download binaries (manual trigger - get latest)
      if: ${{ github.event_name == 'workflow_dispatch' }}
      uses: dawidd6/action-download-artifact@v3
      with:
        workflow: build-from-source-with-ecl.yml
        name: streamvorti-ecl-binaries-ubuntu-22.04
        path: bin

    - name: Install runtime dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y sbcl gnuplot libsuitesparse-dev libopenmpi-dev ecl

    - name: Run with CLI args
      run: |
        set -o pipefail
        chmod +x bin/StreamVorti
        mkdir -p results
        cd results
        ../bin/StreamVorti -dim 2 -nx 20 -ny 20 -nn 25 -Re 100 -dt 0.005 -ft 5.0 -pv 2>&1 | tee simulation.log

    - name: Validate against Ghia
      run: |
        set -o pipefail
        sbcl --non-interactive \
             --load lisp/compare-ghia.lisp \
             --eval '(streamvorti.validation:run-validation :results-file "results/output_dat/mfem_square10x10_u_centerline_x0.5.dat")' \
             2>&1 | tee results/validation.log

    - name: Upload all results
      uses: actions/upload-artifact@v4
      with:
        name: cavity-cli-results
        path: results/
        retention-days: 90

  run-mfemrun:
    name: "MfemRun"
    runs-on: ubuntu-22.04
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}

    steps:
    - uses: actions/checkout@v4

    - name: Download binaries (from triggering workflow)
      if: ${{ github.event_name == 'workflow_run' }}
      uses: actions/download-artifact@v4
      with:
        name: streamvorti-ecl-binaries-ubuntu-22.04
        path: bin
        run-id: ${{ github.event.workflow_run.id }}
        github-token: ${{ secrets.GITHUB_TOKEN }}

    - name: Download binaries (manual trigger - get latest)
      if: ${{ github.event_name == 'workflow_dispatch' }}
      uses: dawidd6/action-download-artifact@v3
      with:
        workflow: build-from-source-with-ecl.yml
        name: streamvorti-ecl-binaries-ubuntu-22.04
        path: bin

    - name: Install runtime dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libsuitesparse-dev libopenmpi-dev ecl

    - name: Run MfemRun
      run: |
        set -o pipefail
        chmod +x bin/MfemRun
        mkdir -p results
        cd results
        ../bin/MfemRun -dim 2 -nx 10 -ny 10 -nn 25 -sd -sn 2>&1 | tee mfemrun.log

    - name: Upload all results
      uses: actions/upload-artifact@v4
      with:
        name: mfemrun-results
        path: results/
        retention-days: 90
