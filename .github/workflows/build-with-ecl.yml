# GitHub Actions workflow for building StreamVorti with ECL (Common Lisp) support
#
# This workflow builds StreamVorti with MFEM, ECL, and all dependencies.
# It includes unit tests and code coverage reporting.
#
# TRIGGERS:
# - Manual workflow_dispatch
# - Push to main branch
# - Pull requests to main branch

name: Build with ECL & Coverage

on:
  workflow_dispatch:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  HYPRE_URL: 'https://github.com/hypre-space/hypre/archive'
  HYPRE_ARCHIVE: v2.19.0
  HYPRE_TOP_DIR: hypre-2.19.0
  METIS_URL: 'https://mfem.github.io/tpls'
  METIS_ARCHIVE: metis-4.0.3.tar.gz
  METIS_TOP_DIR: metis-4.0.3
  MFEM_TOP_DIR: mfem-4.8

jobs:
  build-and-test:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          libcgal-dev \
          libeigen3-dev \
          libopenmpi-dev \
          openmpi-bin \
          ccache \
          lcov \
          ecl \
          libecl-dev

    - name: Create Eigen symlinks
      run: |
        if [ ! -e /usr/include/Eigen ]; then
          sudo ln -sf /usr/include/eigen3/Eigen /usr/include/Eigen
          sudo ln -sf /usr/include/eigen3/unsupported /usr/include/unsupported
        fi

    - name: Setup ccache
      uses: hendrikmuhs/ccache-action@v1.2
      with:
        key: ${{ runner.os }}-ecl-build-ccache
        max-size: "2G"
        verbose: 2

    # Build HYPRE
    - name: Cache HYPRE build
      id: cache-hypre
      uses: actions/cache@v3
      with:
        path: |
          ${{ env.HYPRE_TOP_DIR }}/install
        key: ${{ env.HYPRE_TOP_DIR }}-${{ runner.os }}

    - name: Build HYPRE
      if: steps.cache-hypre.outputs.cache-hit != 'true'
      run: |
        wget -q "${HYPRE_URL}/${HYPRE_ARCHIVE}.tar.gz"
        tar -xzf "${HYPRE_ARCHIVE}.tar.gz"
        cd "${HYPRE_TOP_DIR}/src"
        ./configure --disable-fortran --without-fei --prefix=$GITHUB_WORKSPACE/${HYPRE_TOP_DIR}/install
        make -j$(nproc) install

    # Build METIS
    - name: Cache METIS build
      id: cache-metis
      uses: actions/cache@v3
      with:
        path: |
          ${{ env.METIS_TOP_DIR }}/libmetis.a
          ${{ env.METIS_TOP_DIR }}/Lib
        key: ${{ env.METIS_TOP_DIR }}-${{ runner.os }}

    - name: Build METIS
      if: steps.cache-metis.outputs.cache-hit != 'true'
      run: |
        wget -q "${METIS_URL}/${METIS_ARCHIVE}"
        tar -xzf "${METIS_ARCHIVE}"
        cd "${METIS_TOP_DIR}"
        make -j$(nproc)

    # Build MFEM
    - name: Cache MFEM build
      id: cache-mfem
      uses: actions/cache@v3
      with:
        path: /opt/mfem/${{ env.MFEM_TOP_DIR }}
        key: ${{ env.MFEM_TOP_DIR }}-hypre-metis-${{ runner.os }}

    - name: Build and install MFEM
      if: steps.cache-mfem.outputs.cache-hit != 'true'
      run: |
        wget -q "https://github.com/mfem/mfem/archive/v4.8.tar.gz"
        tar -xzf v4.8.tar.gz
        cd mfem-4.8
        mkdir build && cd build
        cmake .. \
          -DCMAKE_INSTALL_PREFIX=/opt/mfem/${MFEM_TOP_DIR} \
          -DCMAKE_BUILD_TYPE=Release \
          -DMFEM_USE_MPI=OFF \
          -DMFEM_USE_METIS=ON \
          -DMETIS_DIR=$GITHUB_WORKSPACE/${METIS_TOP_DIR}
        make -j$(nproc) install

    # Build StreamVorti with ECL and coverage
    - name: Build StreamVorti with ECL
      run: |
        mkdir -p build
        cd build
        cmake .. \
          -DCMAKE_BUILD_TYPE=Debug \
          -DMFEM_DIR=/opt/mfem/${MFEM_TOP_DIR} \
          -DSTREAMVORTI_WITH_ECL=ON \
          -DSTREAMVORTI_BUILD_TESTS=ON \
          -DENABLE_COVERAGE=ON
        make -j$(nproc)

    - name: Install Google Test
      run: |
        sudo apt-get install -y libgtest-dev
        cd /usr/src/gtest
        sudo cmake .
        sudo make
        sudo cp lib/*.a /usr/lib/ || sudo cp *.a /usr/lib/

    - name: Rebuild with GTest
      run: |
        cd build
        cmake .. \
          -DCMAKE_BUILD_TYPE=Debug \
          -DMFEM_DIR=/opt/mfem/${MFEM_TOP_DIR} \
          -DSTREAMVORTI_WITH_ECL=ON \
          -DSTREAMVORTI_BUILD_TESTS=ON \
          -DENABLE_COVERAGE=ON
        make -j$(nproc)

    - name: Run unit tests
      run: |
        cd build
        ctest --output-on-failure --verbose

    - name: Generate coverage report
      run: |
        cd build
        lcov --capture --directory . --output-file coverage.info
        lcov --remove coverage.info '/usr/*' '*/tests/*' --output-file coverage.info
        lcov --list coverage.info

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: build/coverage.info
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false

    - name: Check built artifacts
      run: |
        echo "=== Checking built artifacts ==="
        ls -la build/
        if [ -f build/MfemRun ]; then
          echo "MfemRun executable found"
          ldd build/MfemRun || true
        fi
        if [ -f build/streamvorti_tests ]; then
          echo "Test executable found"
        fi

    - name: Display ccache statistics
      run: |
        ccache -s

  # Build without ECL (baseline test)
  build-without-ecl:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install system dependencies
      run: ./scripts/build-from-source/01-install-system-dependencies.sh

    - name: Setup ccache and create Eigen symlinks
      run: ./scripts/build-from-source/02-setup-ccache.sh

    - name: Setup ccache
      uses: hendrikmuhs/ccache-action@v1.2
      with:
        key: ${{ runner.os }}-no-ecl-ccache
        max-size: "2G"

    - name: Cache HYPRE build
      id: cache-hypre
      uses: actions/cache@v3
      with:
        path: |
          ${{ env.HYPRE_TOP_DIR }}/install
        key: ${{ env.HYPRE_TOP_DIR }}-${{ runner.os }}

    - name: Build HYPRE
      if: steps.cache-hypre.outputs.cache-hit != 'true'
      run: ./scripts/build-from-source/03-build-hypre.sh "${{ env.HYPRE_URL }}" "${{ env.HYPRE_ARCHIVE }}" "${{ env.HYPRE_TOP_DIR }}"

    - name: Cache METIS build
      id: cache-metis
      uses: actions/cache@v3
      with:
        path: |
          ${{ env.METIS_TOP_DIR }}/libmetis.a
          ${{ env.METIS_TOP_DIR }}/Lib
        key: ${{ env.METIS_TOP_DIR }}-${{ runner.os }}

    - name: Build METIS
      if: steps.cache-metis.outputs.cache-hit != 'true'
      run: ./scripts/build-from-source/04-build-metis.sh "${{ env.METIS_URL }}" "${{ env.METIS_ARCHIVE }}" "${{ env.METIS_TOP_DIR }}"

    - name: Cache MFEM build
      id: cache-mfem
      uses: actions/cache@v3
      with:
        path: /opt/mfem/${{ env.MFEM_TOP_DIR }}
        key: ${{ env.MFEM_TOP_DIR }}-hypre-metis-${{ runner.os }}

    - name: Build and install MFEM
      if: steps.cache-mfem.outputs.cache-hit != 'true'
      run: ./scripts/build-from-source/05-build-mfem.sh "${{ env.MFEM_TOP_DIR }}" "${{ env.HYPRE_TOP_DIR }}" "${{ env.METIS_TOP_DIR }}" "/opt/mfem/${{ env.MFEM_TOP_DIR }}"

    - name: Build StreamVorti (without ECL)
      run: |
        mkdir -p build
        cd build
        cmake .. \
          -DCMAKE_BUILD_TYPE=Release \
          -DMFEM_DIR=/opt/mfem/${MFEM_TOP_DIR} \
          -DSTREAMVORTI_WITH_ECL=OFF
        make -j$(nproc)

    - name: Check built artifacts
      run: ./scripts/build-from-source/08-check-built-artifacts.sh build

    - name: Run example tests
      run: ./scripts/build-from-source/09-run-example-tests.sh "$GITHUB_WORKSPACE/build/MfemRun" "$GITHUB_WORKSPACE/build/StreamVorti"
